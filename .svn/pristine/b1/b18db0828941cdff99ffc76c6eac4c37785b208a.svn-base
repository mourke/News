int query;  // 
ArrayList<Widget> widgets;

ArrayList<Comment> comments;
ArrayList<Story> stories;

ArrayList<Comment> matchingComments;
ArrayList<Story> matchingStories;
Textbox queryTextbox;

ArrayList<RadioButton> usernameSearchOptions;

void settings() {
  size(SCREEN_WIDTH, SCREEN_HEIGHT);
}

void setup() {
  query = QUERY_DEFAULT;    // start by displaying default query

  //Create widgets array
  widgets = new ArrayList<Widget>();

  //declare separate arraylists for comment and story
  comments = new ArrayList<Comment>();
  stories = new ArrayList<Story>();

  // parse json file
  JSONArray array = loadJSONArray("news.json");

  // sort json entries into stories and comments
  for (int i = 0; i < array.size(); ++i) {
    JSONObject object = array.getJSONObject(i);
    try {
      if (object.getString("type").equals("story")) {
        stories.add(new Story(object));
      } else {
        comments.add(new Comment(object));
      }
    } 
    catch (Exception e) {
      println("line " + i + ": " + e);
    }
  }

  //test querying comments by username:
  String username = "andres";
  println("Querying comments & stories by: " + username);
  matchingComments = getCommentsByUsername(comments, username);
  matchingStories = getStoriesByUsername(stories, username);
  //for (Comment c : matchingComments) {
  //  println(c);
  //}
  //for (Story s : matchingStories) {
  //  println(s);
  //}

  //Widget w = new Widget(0,0);
  //widgets.add(w);

  queryTextbox = new Textbox(50, 50);

  textSize(QUERY_TEXT_SIZE);

  //query = QUERY_COMMENT_BY_USERNAME;
  query = QUERY_STORY_BY_USERNAME;

  usernameSearchOptions = new ArrayList<RadioButton>();
  RadioButton commentByUsername = new RadioButton(50, 150, EVENT_COMMENTS_BY_USERNAME, usernameSearchOptions, "Comments: ");
  RadioButton storyByUsername = new RadioButton(350, 150, EVENT_STORIES_BY_USERNAME, usernameSearchOptions, "Stories: ");
  usernameSearchOptions.add(commentByUsername);
  usernameSearchOptions.add(storyByUsername);
}

void draw() {
  // ... visual representation of query ...
  background(0);
  fill(255);
  switch (query) {
    case (QUERY_COMMENT_BY_USERNAME):
    String output = "";
    for (Comment c : matchingComments) {
      output=output+c.toString()+"\n\n";
      text(output, 0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
    }
    break;
    case (QUERY_STORY_BY_USERNAME):
    output = "";
    for (Story s : matchingStories) {
      output=output+s.toString()+"\n\n";
      text(output, 0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
    }
    break;
  }

  queryTextbox.draw();
  
  for (RadioButton r: usernameSearchOptions) {
    r.draw();
  }
}
//for (Widget w: widgets) {
//  w.draw();
//}
//}

ArrayList<Comment> getCommentsByUsername(ArrayList<Comment> comments, String username) {
  ArrayList<Comment> commentsByUsername = new ArrayList<Comment>();

  for (Comment c : comments) {
    try {
      if (c.author().equalsIgnoreCase(username)) {
        commentsByUsername.add(c);
      }
    } 
    catch (Exception e) {
      //println("Error matching username: " + c + ": " + e);
    }
  }

  return commentsByUsername;
}

ArrayList<Story> getStoriesByUsername(ArrayList<Story> stories, String username) {
  ArrayList<Story> storiesByUsername = new ArrayList<Story>();

  for (Story s : stories) {
    try {
      if (s.author().equalsIgnoreCase(username)) {
        storiesByUsername.add(s);
      }
    } 
    catch (Exception e) {
      //println("Error matching username: " + s + ": " + e);
    }
  }

  return storiesByUsername;
}

void mousePressed() {
  if (queryTextbox.withinBounds(mouseX, mouseY)) {
    queryTextbox.click();
  } else {
    queryTextbox.deselect();
  }
  for (RadioButton r: usernameSearchOptions) {
    
  }
}

void keyPressed() {
  if (queryTextbox.isSelected()) {
    if (key == BACKSPACE) {
      queryTextbox.removeChar();
    } else if (key == ENTER) {
      queryTextbox.submitQuery();
    } else {
      queryTextbox.appendCharacter(key);
    }
  }
}

//As per the project specification, the goal this week is to display the 
//results of at least one query on the screen.

//Thus, the minimal program will:

// - read in and store the data from the JSON file. DONE

// - run a simple query (e.g. stories matching a particular username), store the
//results of this query, and set the current query type to be that query.

// - (in draw()) draw the results of the current query using a combination of text
//and graphics (e.g. bar chart of the number of comments on these stories).
//int i = 0;
//for (int y = QUERY_TEXT_SIZE; y + QUERY_TEXT_SIZE < SCREEN_HEIGHT && i < matchingComments.size(); y+=QUERY_TEXT_SIZE) {
//  String s = matchingComments.get(i).toString();
//  text(s, 0, y);
//  //adjust y pos of next string in case of multiple lines.
//  String[] linesInComment = s.split("\n");
//  y+= QUERY_TEXT_SIZE * linesInComment.length;
//  i++;

void setUsername(String s) {
  matchingComments = getCommentsByUsername(comments, s);
  matchingStories = getStoriesByUsername(stories, s);
}
